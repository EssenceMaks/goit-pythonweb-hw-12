# Contact Management System

## Швидкий запуск

```sh
# Клонувати репозиторій
git clone https://github.com/EssenceMaks/goit-pythonweb-hw-10.git
cd goit-pythonweb-hw-10

# Заповнити файл .env необхідними даними
cp .env.example .env
# Відредагувати .env вашими особистими налаштуваннями
smtp google
cloudinary api
Super Admin login and pass

# Запустити через Docker Compose
docker-compose up --build

# Відкрийте у браузері http://localhost:8000/
# Перший логін виконайте за допомогою облікового запису Super Admin, щоб створити базу даних
# Використовуйте https://temp-mail.org/ для верифікації тестових акаунтів
```

## Опис проєкту

Це сучасний, повнофункціональний застосунок для керування контактами з розширеними можливостями персоналізації та безпеки. Проєкт побудовано на FastAPI з використанням SQLAlchemy та PostgreSQL. Система містить зручний веб-інтерфейс зі "скляним" дизайном для комфортної роботи з контактами, а також повноцінну систему автентифікації та авторизації.

---

## Основні можливості

### Управління контактами
- Зберігання контактів з такими полями: ім'я, прізвище, email, телефон, день народження, додаткові дані
- Повний набір CRUD-операцій через API та інтуїтивний веб-інтерфейс
- Розширений пошук контактів за різними параметрами
- Вивід контактів з днями народження на найближчі 7 днів
- Групування контактів для зручнішої організації

### Система автентифікації
- Реєстрація та вхід користувачів з використанням JWT-токенів
- Верифікація email через підтвердження
- Відновлення паролю через email
- Обмеження кількості запитів (rate limiting) для безпеки
- Підтримка множинних сесій (мультилогін) з одного або різних пристроїв
- Система керування обліковими записами через account-section

### Система ролей користувачів
- Три рівні користувачів з різними правами доступу:
  - **Super Admin** - повний контроль над системою, можливість керувати усіма користувачами та їх ролями
  - **Admin** - розширені можливості модерації та керування контентом
  - **User** - базові можливості роботи з власними контактами

### Персоналізація
- Управління профілем користувача
- Завантаження та зміна декількох аватарів через Cloudinary
- Налаштування ролей користувачів (користувач, адміністратор)

### Технічні особливості
- Сучасний, адаптивний "скляний" дизайн інтерфейсу
- REST API з повною документацією
- Безпечне зберігання паролів із використанням хешування
- Docker-підтримка для швидкого розгортання

---

## Як завантажити та запустити проєкт

### Метод 1: Стандартна установка

1. **Клонуйте репозиторій:**
   ```sh
   git clone https://github.com/EssenceMaks/goit-pythonweb-hw-10.git
   cd goit-pythonweb-hw-10
   ```

2. **Встановіть залежності:**
   ```sh
   pip install -r requirements.txt
   ```

3. **Створіть .env файл:**
   ```sh
   cp .env.example .env
   ```
   
4. **Заповніть .env необхідними даними:**
   ```
   DATABASE_URL=postgresql://postgres:YOUR_PASSWORD@localhost:5432/contacts_db
   SECRET_KEY=your_secret_key_for_jwt
   MAIL_USERNAME=your_email@gmail.com
   MAIL_PASSWORD=your_app_password
   MAIL_FROM=your_email@gmail.com
   MAIL_SERVER=smtp.gmail.com
   
   # Cloudinary configuration
   CLOUDINARY_CLOUD_NAME=your_cloud_name
   CLOUDINARY_API_KEY=your_api_key
   CLOUDINARY_API_SECRET=your_api_secret
   
   # Super Admin configuration
   SUPER_ADMIN_EMAIL=super_admin@example.com
   SUPER_ADMIN_PASSWORD=strong_password_for_super_admin
   SUPER_ADMIN_USERNAME=super_admin
   ```

5. **Ініціалізуйте базу даних:**
   ```sh
   python create_db.py
   python initialize_db.py

   або простіше 
   через запущений проект у докер
   docker-compose up --build

   ```

6. **Запустіть сервер:**
   ```sh
   uvicorn main:app --reload
   ```

7. **Відкрийте у браузері:**
   - UI: http://localhost:8000/
   - Swagger API: http://localhost:8000/docs

### Метод 2: Docker

1. **Клонуйте репозиторій та перейдіть до директорії проєкту**

2. **Налаштуйте .env файл як описано вище**

3. **Запустіть з Docker Compose:**
   ```sh
   docker-compose up -d
   ```

4. **Відкрийте у браузері:**
   - UI: http://localhost:8000/
   - Swagger API: http://localhost:8000/docs

---

## Функціональність API

### Аутентифікація
- `POST /signup` - Реєстрація нового користувача
- `POST /login` - Вхід у систему
- `POST /logout` - Вихід із системи
- `POST /verify/{token}` - Верифікація email
- `POST /forgot` - Запит на відновлення паролю
- `POST /reset/{token}` - Скидання паролю

### Користувачі
- `GET /users/me` - Отримання інформації про поточного користувача
- `PATCH /users/update/username` - Оновлення імені користувача
- `PATCH /users/update/password` - Зміна паролю
- `GET /users/avatars` - Отримання списку аватарів користувача
- `POST /users/avatars/upload` - Завантаження нового аватара
- `PATCH /users/avatars/{avatar_id}/set-main` - Встановлення головного аватара
- `DELETE /users/avatars/{avatar_id}` - Видалення аватара

### Контакти
- `GET /api/contacts` - Отримання списку контактів
- `GET /api/contacts/{contact_id}` - Отримання деталей контакту
- `POST /api/contacts` - Створення нового контакту
- `PUT /api/contacts/{contact_id}` - Повне оновлення контакту
- `PATCH /api/contacts/{contact_id}` - Часткове оновлення контакту
- `DELETE /api/contacts/{contact_id}` - Видалення контакту
- `GET /api/contacts/birthdays` - Отримання контактів з днями народження на найближчі 7 днів

### Групи контактів
- `GET /api/groups` - Отримання списку груп
- `POST /api/groups` - Створення нової групи
- `GET /api/groups/{group_id}` - Отримання деталей групи
- `PUT /api/groups/{group_id}` - Оновлення групи
- `DELETE /api/groups/{group_id}` - Видалення групи

---

## Система автентифікації та керування обліковим записом

### Мультилогін (Multiple Sessions)
Система підтримує одночасну роботу користувача з кількох пристроїв або браузерів:

- **Управління сесіями** — користувач може переглядати список активних сесій у розділі "Account Section"
- **Безпека сесій** — кожна сесія захищена унікальним JWT-токеном із обмеженим терміном дії
- **Примусове завершення сесій** — можливість завершити окремі або всі сесії, окрім поточної
- **Моніторинг активності** — відображення інформації про останню активність для кожної сесії
- **Інформація про пристрої** — система зберігає дані про пристрій, браузер та IP-адресу для кожного входу

### Account Section
У розділі "Account Section" доступні наступні можливості:

- **Управління профілем** — редагування особистої інформації та налаштувань облікового запису
- **Зміна аватара** — вибір та завантаження зображення профілю з галереї або з власного пристрою
- **Керування безпекою** — зміна паролю, налаштування двофакторної аутентифікації
- **Перегляд активних сесій** — моніторинг та управління поточними підключеннями
- **Повідомлення про вхід** — налаштування отримання сповіщень про вхід в аккаунт з нового пристрою
- **Журнал дій** — перегляд історії дій, пов'язаних з обліковим записом

#### Доступ до Account Section
- Для користувачів (User) — доступне управління власним профілем та сесіями
- Для адміністраторів (Admin) — додаткові можливості модерації та керування журналами дій
- Для суперадміністраторів (Super Admin) — повний доступ до всіх функцій керування всіма обліковими записами

### Рекомендації з безпеки
- Змініть пароль Super Admin одразу після першого входу
- Обмежуйте кількість користувачів з роллю Admin
- Регулярно перевіряйте активність адміністраторів через логи
- При зміні конфігурації в .env файлі перезапустіть сервер для застосування змін

---

## Система ролей користувачів

У системі реалізовано три рівні доступу з різними можливостями:

### 1. Super Admin
- **Повноваження:**
  - Повний контроль над усіма функціями системи
  - Створення, редагування та видалення будь-яких користувачів
  - Зміна ролей користувачів
  - Доступ до всіх контактів у системі
  - Керування технічними налаштуваннями системи
  - Перегляд логів та статистики
- **Налаштування:**
  - Super Admin створюється автоматично при першому запуску системи з даними, вказаними в .env файлі
  - Змінити дані Super Admin можна тільки через пряме редагування бази даних або через спеціальний утиліти

### 2. Admin
- **Повноваження:**
  - Модерація контенту користувачів
  - Блокування/розблокування звичайних користувачів
  - Обмежений доступ до контактів інших користувачів (без можливості редагування особистих даних)
  - Можливість створювати системні групи контактів
  - Доступ до базової статистики використання системи
- **Призначення:**
  - Роль Admin може бути призначена тільки Super Admin або іншим adminom через загальний інтерфейс інформації через кнопки "Зробити адміном" чи "Зробити просто юзером"

### 3. User
- **Повноваження:**
  - Створення та керування власними контактами
  - Налаштування особистого профілю
  - Завантаження персональних аватарів
  - Створення та керування власними групами контактів
  - Пошук та фільтрація власних контактів
- **Реєстрація:**
  - Доступна через форму реєстрації з верифікацією email
  - За замовчуванням всі нові користувачі отримують роль User

### Рекомендації з безпеки
- Змініть пароль Super Admin одразу після першого входу
- Обмежуйте кількість користувачів з роллю Admin
- Регулярно перевіряйте активність адміністраторів через логи
- При зміні конфігурації в .env файлі перезапустіть сервер для застосування змін

---

## Технічні вимоги

- Python 3.9+
- PostgreSQL
- SMTP-сервер для відправки електронних листів
- Акаунт Cloudinary для зберігання зображень

---

## Додаткові можливості

### Генерація тестових даних
Проєкт має вбудовані засоби для генерації тестових даних для швидкого дослідження функціональності:

використовуйте веб-інтерфейс для генерації даних через відповідну кнопку у Super Admin -a

---

## Схема бази даних

Система використовує реляційну базу даних з такими основними таблицями:
- `users` - користувачі системи
- `contacts` - контакти кожного користувача
- `contact_groups` - групи контактів
- `user_avatars` - збережені аватари користувачів
- `tokens` - токени для підтвердження email та відновлення паролю

---

---

## Повний список API (fetch) запитів, які виконує фронтенд

**User Settings:**
- `GET /users/me` — отримати дані користувача
- `GET /logout` — вихід із системи
- `GET /users/avatar-requests` — отримати запити на аватари
- `POST /users/{userId}/set-role` — змінити роль користувача
- `PATCH /users/update/username` — змінити ім'я користувача
- `PATCH /users/update/password` — змінити пароль

**User Avatar Settings:**
- `GET /users/avatars` — отримати список аватарів
- `POST /users/avatars/upload` — завантажити новий аватар
- `POST /users/avatars/{avatarId}/request-main` — подати запит на встановлення основного аватара
- `POST /users/avatar-requests/{avatarId}/cancel` — скасувати запит на аватар
- `PATCH /users/avatars/{avatarId}/set-main` — встановити аватар основним
- `DELETE /users/avatars/{avatarId}` — видалити аватар

**Menu:**
- `GET /users/me` — отримати дані користувача (аватар, ім'я)
- `GET /db/check-state` — перевірити стан бази даних
- `POST /users/{userId}/set-role` — змінити роль користувача

**Popups:**
- `POST <form.action або window.location.pathname>` — надсилання форми контакту

**Contacts:**
- Використовуються функції fetchAndRenderContactsInner та fetchContact, які виконують запити:
  - `GET /api/contacts` — отримати контакти
  - `GET /api/contacts/{id}` — отримати контакт за id

---

## Використання Redis

Redis використовується лише для обмеження кількості запитів (rate limiting) через fastapi-limiter:

- Ініціалізація з'єднання з Redis (`REDIS_URL` з env)
- Обмеження кількості запитів на ендпоінти (наприклад, 25 запитів на хвилину на `/users/me`)
- Якщо Redis недоступний — обмеження не застосовуються

**Redis не використовується для зберігання користувацьких даних чи сесій, лише для лімітування запитів.**

---

## Структура бази даних (PostgreSQL)

Docker піднімає сервіси:
- `db` (PostgreSQL 15)
- `redis` (alpine)
- `web` (FastAPI)

### Основні таблиці та їх структура

| Таблиця                | Поля                                                                                                                           |
|------------------------|--------------------------------------------------------------------------------------------------------------------------------|
| users                  | id, username, email, hashed_password, role, is_verified, verification_code                                                     |
| user_avatars           | id, user_id, file_path, cloudinary_public_id, is_approved, is_main, request_type, request_status, created_at, updated_at       |
| avatar_request_messages| id, user_id, avatar_id, message, status, created_at, reviewed_by, reviewed_at                                                  |
| contacts               | id, user_id, first_name, last_name, email, birthday, extra_info                                                                |
| phone_numbers          | id, contact_id, number, label                                                                                                  |
| groups                 | id, name                                                                                                                       |
| contact_group          | contact_id, group_id                                                                                                           |
| avatars                | id, contact_id, file_path, is_main, show                                                                                       |
| photos                 | id, contact_id, file_path, is_main, show                                                                                       |
| password_resets        | id, user_id, token, created_at, expires_at, is_used                                                                            |

**Всі зв'язки та типи полів описані у models.py.**

---
